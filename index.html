<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Note for Us - Window Edit Mode</title>
<style>
  :root {
    --color-bg: #ffffff;
    --color-text: #374151;
    --color-text-muted: #6b7280;
    --color-primary: #111827;
    --color-primary-hover: #1f2937;
    --card-bg: #f9fafb;
    --card-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    --border-radius: 0.75rem;
    --font-heading: 'Poppins', system-ui, sans-serif;
    --font-body: 'Inter', system-ui, sans-serif;
    --spacing-gap: 1.5rem;
    --transition-speed: 0.3s;
  }
  body.dark {
    --color-bg: #18181b;
    --color-text: #d1d5db;
    --color-text-muted: #a1a1aa;
    --color-primary: #facc15;
    --color-primary-hover: #fde047;
    --card-bg: #27272a;
    --card-shadow: 0 1px 10px rgb(0 0 0 / 0.5);
  }
  @import url('https://fonts.googleapis.com/css2?family=Inter&family=Poppins:wght@600&display=swap');
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--color-bg);
    color: var(--color-text);
    font-family: var(--font-body);
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  a { color: var(--color-primary); text-decoration: none; }
  a:hover, button:hover { color: var(--color-primary-hover); }

  .container {
    width: min(100% - 2rem, 1200px);
    margin: 0 auto;
    padding: 3rem 0;
    flex: 1;
  }
  header {
    position: sticky;
    top: 0;
    background: var(--color-bg);
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    z-index: 10;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.05);
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  header h1 {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 2rem;
    margin: 0;
    color: var(--color-primary);
    user-select: none;
    transition: color var(--transition-speed);
  }
  nav {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
  }
  nav button, #resetNotesBtn, #sortNotesBtn, #moveBtn {
    font-family: var(--font-body);
    font-size: 1rem;
    padding: 0.5rem 1rem;
    border: 2px solid var(--color-primary);
    background: transparent;
    color: var(--color-primary);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color var(--transition-speed), color var(--transition-speed), transform var(--transition-speed);
    user-select: none;
  }
  nav button:focus-visible, #resetNotesBtn:focus-visible, #sortNotesBtn:focus-visible, #moveBtn:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }
  nav button:hover, #resetNotesBtn:hover, #sortNotesBtn:hover, #moveBtn:hover {
    background-color: var(--color-primary);
    color: var(--color-bg);
    transform: scale(1.08);
  }
  #darkToggle {
    border: none;
    background: none;
    font-size: 1.4rem;
    padding: 0.2rem 0.7rem;
    margin-left: 0.4rem;
    color: var(--color-primary);
    transition: color var(--transition-speed), transform 0.2s;
    outline: none;
  }
  #darkToggle:hover {
    color: var(--color-primary-hover);
    background: none;
    transform: scale(1.2) rotate(-12deg);
  }
  #notesView {
    display: block;
  }
  #videoDrawingView {
    display: none;
    flex-direction: column;
    height: 100vh;
    background: var(--color-bg);
    color: var(--color-text);
  }
  #videoDrawingView.active {
    display: flex;
  }

  /* Notes grid */
  #notes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--spacing-gap);
  }
  .note-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    transition: box-shadow var(--transition-speed), background var(--transition-speed), color var(--transition-speed), transform 0.3s cubic-bezier(.23,1.02,.53,.97);
    position: relative;
    opacity: 0;
    transform: translateY(40px) scale(0.96);
    animation: cardIn 0.5s cubic-bezier(.23,1.02,.53,.97) forwards;
    cursor: pointer;
  }
  .note-card.pinned {
    border: 2px solid var(--color-primary);
    background: #fffbe7;
    box-shadow: 0 4px 14px rgb(255 205 0 / 0.12);
  }
  body.dark .note-card.pinned {
    background: #3c2f13;
  }
  .note-card:focus-within, .note-card:hover {
    box-shadow: 0 4px 14px rgb(0 0 0 / 0.15);
    transform: scale(1.04) translateY(-3px);
  }
  @keyframes cardIn {
    to {
      opacity: 1;
      transform: translateY(0px) scale(1);
    }
  }
  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    gap: 0.5rem;
  }
  .note-title {
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 1.25rem;
    margin: 0;
    color: var(--color-primary);
    flex: 1 1 auto;
    transition: color var(--transition-speed);
  }
  .note-actions {
    display: flex;
    gap: 0.3rem;
    align-items: center;
  }
  .note-actions button {
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--color-primary);
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-weight: 600;
    transition: background-color var(--transition-speed), color var(--transition-speed), transform var(--transition-speed);
    font-size: 1.15rem;
  }
  .note-actions button:hover {
    background-color: var(--color-primary);
    color: var(--color-bg);
    transform: scale(1.12) rotate(-8deg);
  }
  .note-actions .pin-btn {
    font-size: 1.1em;
    color: #d97706;
  }
  .note-card.pinned .note-actions .pin-btn {
    color: #f59e42;
  }
  .note-content-preview {
    white-space: pre-wrap;
    color: var(--color-text);
    font-family: var(--font-body);
    font-size: 1rem;
    line-height: 1.5;
    min-height: 3.5rem;
    overflow: hidden;
    user-select: none;
  }
  #customizePanel {
    margin-top: 2.5rem;
    border-top: 1px solid #e5e7eb;
    padding-top: 1.5rem;
    font-size: 0.9rem;
    color: var(--color-text-muted);
    transition: color var(--transition-speed), border-color var(--transition-speed);
    animation: fadeInPanel 0.7s cubic-bezier(.23,1.02,.53,.97);
  }
  @keyframes fadeInPanel {
    from { opacity: 0; transform: translateY(30px);}
    to { opacity: 1; transform: translateY(0);}
  }
  #customizePanel h2 {
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
  }
  #customizeCheckboxes {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-top: 0.7rem;
  }
  .customize-row {
    display: flex;
    align-items: center;
    gap: 0.9em;
    padding: 0.5em 0.7em;
    background: var(--card-bg);
    border-radius: 0.5em;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
    font-size: 1.05em;
    cursor: grab;
    transition: background 0.18s, border 0.18s, box-shadow 0.18s;
    user-select: none;
    border: 2px solid transparent;
    min-height: 2.4em;
    touch-action: pan-y;
  }
  .customize-row:active { cursor: grabbing; }
  .customize-row .drag-icon {
    font-size: 1.4em;
    margin-right: 0.35em;
    cursor: grab;
    opacity: 0.9;
    user-select: none;
    transition: color 0.2s;
  }
  .customize-row.dragging {
    opacity: 0.4;
    background: #fff6d1;
    border: 2px solid var(--color-primary);
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    z-index: 1;
  }
  body.dark .customize-row.dragging { background: #453c24; }
  .customize-row.dragover {
    border: 2px dashed var(--color-primary);
    background: #e8f3ff;
  }
  body.dark .customize-row.dragover { background: #32363c; }
  .customize-row input[type="checkbox"] {
    accent-color: var(--color-primary);
    width: 1.2em;
    height: 1.2em;
    margin-right: 0.2em;
    margin-left: 0.1em;
    flex-shrink: 0;
  }
  #passwordOverlay, #fullAccessOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    animation: fadeInOverlay 0.7s cubic-bezier(.23,1.02,.53,.97);
  }
  @keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  #passwordForm, #fullAccessForm {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 400px;
    animation: panelPopIn 0.6s cubic-bezier(.23,1.02,.53,.97);
  }
  @keyframes panelPopIn {
    from { transform: scale(0.92) translateY(30px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }
  #passwordForm h2, #fullAccessForm h2 {
    margin-top: 0;
    color: var(--color-primary);
    font-family: var(--font-heading);
  }
  #passwordInput, #fullAccessInput {
    width: 100%;
    padding: 0.75rem;
    margin: 1rem 0;
    border: 2px solid var(--color-text-muted);
    border-radius: var(--border-radius);
    font-family: var(--font-body);
    font-size: 1rem;
    transition: border-color var(--transition-speed);
  }
  #passwordInput:focus, #fullAccessInput:focus {
    outline: none;
    border-color: var(--color-primary);
  }
  #passwordSubmit, #fullAccessSubmit {
    width: 100%;
    padding: 0.75rem;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-family: var(--font-body);
    font-size: 1rem;
    cursor: pointer;
    transition: background-color var(--transition-speed), transform 0.2s;
  }
  #passwordSubmit:hover, #fullAccessSubmit:hover {
    background: var(--color-primary-hover);
    transform: scale(1.07);
  }
  .error-message {
    color: #ef4444;
    margin-top: 0.5rem;
    font-size: 0.95rem;
    display: none;
    animation: shake 0.25s;
    background: #fef2f2;
    border-radius: 0.5rem;
    padding: 0.3rem 0.6rem;
  }
  @keyframes shake {
    10%, 90% { transform: translateX(-2px);}
    20%, 80% { transform: translateX(4px);}
    30%, 50%, 70% { transform: translateX(-8px);}
    40%, 60% { transform: translateX(8px);}
  }
  #viewOnlyLoginBtn {
    margin: 2rem auto 0 auto;
    display: block;
    font-size: 1rem;
    padding: 0.7rem 1.3rem;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color var(--transition-speed), transform 0.2s;
  }
  #viewOnlyLoginBtn:hover {
    background: var(--color-primary-hover);
    transform: scale(1.08) rotate(-3deg);
  }
  button:focus-visible {
    outline: 2px solid var(--color-primary-hover);
    outline-offset: 2px;
  }
  @media (max-width: 480px) {
    header h1 {
      font-size: 1.5rem;
    }
    nav button, #resetNotesBtn, #sortNotesBtn, #moveBtn {
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
    }
    #notes {
      grid-template-columns: 1fr;
    }
    #viewOnlyLoginBtn { width: 100%; }
    .customize-row { font-size: 0.97em; padding: 0.44em 0.3em; }
  }

  /* Modal Window for Note Editing */
  #noteModalOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }
  #noteModalOverlay.active {
    display: flex;
  }
  #noteModal {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    width: 90%;
    max-width: 600px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    padding: 1.5rem 2rem;
    overflow-y: auto;
    position: relative;
  }
  #noteModal header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  #noteModal header h2 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    margin: 0;
    color: var(--color-primary);
  }
  #noteModal header button.close-btn {
    background: transparent;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    color: var(--color-primary);
    padding: 0;
    line-height: 1;
    transition: color var(--transition-speed);
  }
  #noteModal header button.close-btn:hover,
  #noteModal header button.close-btn:focus-visible {
    color: var(--color-primary-hover);
  }
  #noteModal input.title-input {
    font-family: var(--font-heading);
    font-size: 1.45rem;
    font-weight: 600;
    border: 2px solid var(--color-primary);
    border-radius: var(--border-radius);
    padding: 0.3rem 0.75rem;
    width: 100%;
    box-sizing: border-box;
    color: var(--color-text);
    background: transparent;
    transition: border-color var(--transition-speed), background-color var(--transition-speed), color var(--transition-speed);
  }
  #noteModal input.title-input:focus {
    outline: none;
    border-color: var(--color-primary-hover);
    background-color: var(--card-bg);
    color: var(--color-text);
  }
  #noteModal textarea.content-textarea {
    flex: 1;
    margin-top: 1rem;
    font-family: var(--font-body);
    font-size: 1rem;
    line-height: 1.5;
    color: var(--color-text);
    background: transparent;
    border: 2px solid var(--color-primary);
    border-radius: var(--border-radius);
    resize: vertical;
    min-height: 220px;
    padding: 0.75rem 1rem;
    transition: border-color var(--transition-speed);
  }
  #noteModal textarea.content-textarea:focus {
    outline: none;
    border-color: var(--color-primary-hover);
  }
  #noteModal .modal-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 1rem;
    gap: 0.75rem;
  }
  #noteModal button.action-btn {
    font-family: var(--font-body);
    font-size: 1rem;
    padding: 0.5rem 1.2rem;
    border-radius: var(--border-radius);
    border: 2px solid var(--color-primary);
    background: var(--color-primary);
    color: var(--color-bg);
    cursor: pointer;
    user-select: none;
    transition: background-color var(--transition-speed), transform 0.2s ease;
  }
  #noteModal button.action-btn:hover {
    background-color: var(--color-primary-hover);
    transform: scale(1.08);
  }
  #noteModal button.pin-toggle {
    background-color: transparent;
    color: var(--color-primary);
    border-color: var(--color-primary);
  }
  #noteModal button.pin-toggle.pinned {
    background-color: #fffbe7;
    color: #d97706;
    border-color: #d97706;
  }
  body.dark #noteModal button.pin-toggle.pinned {
    background-color: #3c2f13;
    color: #f59e42;
    border-color: #f59e42;
  }
  /* Accessibility: hiding scrollbars on overlay */
  #noteModalOverlay::-webkit-scrollbar {
    display: none;
  }
  /* Responsive adjustments */
  @media (max-width: 640px) {
    #noteModal {
      max-width: 95vw;
      padding: 1rem;
    }
    #noteModal textarea.content-textarea {
      min-height: 160px;
    }
  }
</style>
</head>
<body>
<!-- Password overlay (shown first) -->
<div id="passwordOverlay" aria-modal="true" role="dialog">
  <div id="passwordForm">
    <h2>Enter password to continue</h2>
    <input type="password" id="passwordInput" aria-label="Enter password" placeholder="Enter password" autocomplete="off" />
    <p id="passwordError" class="error-message" aria-live="polite">Incorrect password. Please try again.</p>
    <button id="passwordSubmit">Continue</button>
  </div>
</div>
<!-- Full access overlay (appears in view-only mode) -->
<div id="fullAccessOverlay" style="display: none;" aria-modal="true" role="dialog">
  <div id="fullAccessForm">
    <h2>Enter full access code</h2>
    <input type="password" id="fullAccessInput" aria-label="Enter full access code" placeholder="Enter full access code" autocomplete="off" />
    <p id="fullAccessError" class="error-message" aria-live="polite">Wrong code! Please try again.</p>
    <button id="fullAccessSubmit">Login</button>
  </div>
</div>
<!-- Main Content -->
<div id="mainContent" style="display: none; flex: 1; display: flex; flex-direction: column;">
  <header>
    <h1>Note for me and won :3</h1>
    <nav aria-label="Main navigation" style="position: relative;">
      <button id="resetNotesBtn" aria-label="Reset to default notes">Reset</button>
      <button id="sortNotesBtn" aria-label="Sort notes" title="Sort notes">Sort</button>
      <button id="moveBtn" aria-label="Open drawing view">Move</button>
      <div id="sortMenu" class="sort-menu" aria-label="Sort menu">
        <button data-sort="pinned">Pinned first</button>
        <button data-sort="title">By title</button>
        <button data-sort="newest">Newest first</button>
      </div>
      <button id="darkToggle" aria-label="Toggle dark mode" title="Toggle dark mode">üåô</button>
    </nav>
  </header>

  <!-- Notes View -->
  <main class="container" id="notesView">
    <section>
      <button id="newNoteBtn" style="display:none;" aria-label="Add new note">+ New Note</button>
      <input id="searchNotes" type="search" placeholder="Search notes..." aria-label="Search notes" style="width:100%;max-width:400px;margin-bottom:1.5rem;font-size:1rem;padding:0.5rem;border-radius:0.5rem;border:1px solid #e5e7eb;" />
    </section>
    <section id="notes" aria-live="polite" aria-relevant="additions removals"></section>
    <section id="customizePanel" aria-label="Customize visible notes and sections">
      <h2>Edit</h2>
      <div id="customizeCheckboxes"></div>
    </section>
    <button id="viewOnlyLoginBtn" style="display: none;">Login for full access</button>
    <div id="viewOnlyInfo" style="display: none; color: var(--color-text-muted); font-size: 1em; margin-top: 1.5em;" aria-live="polite">
      <span>View-only mode: You can read notes, but editing is disabled.</span>
    </div>
  </main>

  <!-- Drawing View -->
  <section id="videoDrawingView" aria-label="Drawing canvas panel">
    <header>
      <h2>Drawing Canvas</h2>
      <button id="closeVideoDrawingBtn" aria-label="Back to notes">Back</button>
    </header>
    <div id="drawingControls" aria-label="Drawing controls" style="padding: 0.5rem 1rem;">
      <label for="colorPicker" style="margin-right:0.5rem;">Color:</label>
      <input type="color" id="colorPicker" value="#facc15" title="Pick drawing color" />
      <label for="lineWidthRange" style="margin-left:1rem; margin-right:0.5rem;">Line width:</label>
      <select id="lineWidthRange" title="Select line width">
        <option value="2">Thin</option>
        <option value="4" selected>Medium</option>
        <option value="8">Thick</option>
        <option value="12">Extra Thick</option>
      </select>
      <button id="pencilBtn" title="Pencil tool" aria-label="Pencil tool" class="active" style="margin-left:1rem;">‚úèÔ∏è</button>
      <button id="rectangleBtn" title="Draw rectangle" aria-label="Rectangle tool">üü¶</button>
      <button id="circleBtn" title="Draw circle" aria-label="Circle tool">‚ö™</button>
      <button id="eraserBtn" title="Eraser tool" aria-label="Eraser tool">üßΩ</button>
      <button id="undoBtn" title="Undo last action" aria-label="Undo last action" style="margin-left:1rem;">‚Ü©Ô∏è</button>
      <button id="redoBtn" title="Redo last undone action" aria-label="Redo last action">‚Ü™Ô∏è</button>
      <button id="clearCanvasBtn" title="Clear drawing" style="margin-left:1rem;">Clear</button>
      <button id="saveCanvasBtn" title="Save drawing as PNG" style="margin-left:1rem;">Save</button>
    </div>
    <canvas id="drawingCanvas" role="img" aria-label="Drawing canvas" tabindex="0" style="flex-grow:1; width:100%; height:100%; border-top: 1px solid var(--color-text-muted);"></canvas>
  </section>
</div>

<!-- Modal for editing notes-->
<div id="noteModalOverlay" role="dialog" aria-modal="true" aria-labelledby="noteModalTitle">
  <div id="noteModal" tabindex="-1">
    <header>
      <h2 id="noteModalTitle">Edit Note</h2>
      <button class="close-btn" aria-label="Close note window">&times;</button>
    </header>
    <input type="text" id="modalNoteTitle" class="title-input" aria-label="Edit note title" autocomplete="off" />
    <textarea id="modalNoteContent" class="content-textarea" aria-label="Edit note content"></textarea>
    <div class="modal-actions">
      <button id="modalPinToggle" class="pin-toggle" aria-pressed="false" title="Pin or unpin note">üìç Pin</button>
      <button id="modalDeleteBtn" class="action-btn" title="Delete note">Delete</button>
      <button id="modalCloseBtn" class="action-btn">Close</button>
    </div>
  </div>
</div>

<script>
  // ---- Theme: Dark/Light ----
  const THEME_KEY = "notesAppTheme";
  function setTheme(theme) {
    document.body.classList.toggle("dark", theme === "dark");
    localStorage.setItem(THEME_KEY, theme);
    const darkToggle = document.getElementById("darkToggle");
    if(darkToggle) {
      darkToggle.innerText = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    }
  }
  function toggleTheme() {
    const newTheme = document.body.classList.contains("dark") ? "light" : "dark";
    setTheme(newTheme);
  }
  function initTheme() {
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) {
      setTheme(stored);
    } else {
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      setTheme(prefersDark ? "dark" : "light");
    }
    const darkToggle = document.getElementById("darkToggle");
    if(darkToggle) darkToggle.addEventListener("click", toggleTheme);
  }

  // ---- Auth ----
  const CORRECT_PASSWORD = "11331122";
  const FULL_ACCESS_CODE = "pay gorn";
  const PASSWORD_STORAGE_KEY = "notesAppAuthenticated";
  const FULL_ACCESS_KEY = "notesAppFullAccess";
  function isAuthenticated() {
    return localStorage.getItem(PASSWORD_STORAGE_KEY) === "true";
  }
  function hasFullAccess() {
    return localStorage.getItem(FULL_ACCESS_KEY) === "true";
  }
  function setAuthenticated() {
    localStorage.setItem(PASSWORD_STORAGE_KEY, "true");
  }
  function setFullAccess() {
    localStorage.setItem(FULL_ACCESS_KEY, "true");
  }
  // ---- Notes State ----
  const defaultNotes = [
    { id: 'note1', title: 'dream', content: 'i wish i hade someone really understand me like ... idk won i cant type here bcuz anyways u see it :3', pinned: false, created: Date.now() },
    { id: 'note2', title: 'YouTube Link', content: 'https://www.youtube.com/watch?v=LgUnKB2nY-4', pinned: false, created: Date.now() },
    { id: 'note3', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
    { id: 'note4', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
    { id: 'note5', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
    { id: 'note6', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
    { id: 'note7', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
    { id: 'note8', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
    { id: 'note9', title: 'Reminder', content: 'WE GOTTA BUY IT!', pinned: false, created: Date.now() },
  ];
  let notes = JSON.parse(localStorage.getItem('notes')) || defaultNotes.map(n => ({ ...n, visible: true }));
  let selectedNoteId = null; // for keyboard shortcuts

  function saveNotes() {
    localStorage.setItem('notes', JSON.stringify(notes));
  }

  // ---- Auth Forms ----
  function handlePasswordSubmit() {
    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    if (passwordInput.value === CORRECT_PASSWORD) {
      setAuthenticated();
      document.getElementById('passwordOverlay').style.display = 'none';
      document.getElementById('mainContent').style.display = 'flex';
      renderApp();
    } else {
      passwordError.style.display = 'block';
      passwordInput.value = '';
      passwordInput.focus();
    }
  }
  function setupPasswordForm() {
    document.getElementById('passwordSubmit').addEventListener('click', handlePasswordSubmit);
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') handlePasswordSubmit();
    });
    document.getElementById('passwordInput').addEventListener('input', function() {
      document.getElementById('passwordError').style.display = 'none';
    });
  }
  function handleFullAccessSubmit() {
    const codeInput = document.getElementById('fullAccessInput');
    const codeError = document.getElementById('fullAccessError');
    if (codeInput.value.trim() === FULL_ACCESS_CODE) {
      setFullAccess();
      document.getElementById('fullAccessOverlay').style.display = 'none';
      renderApp();
    } else {
      codeError.style.display = 'block';
      codeInput.value = '';
      codeInput.focus();
    }
  }
  function setupFullAccessForm() {
    document.getElementById('fullAccessSubmit').addEventListener('click', handleFullAccessSubmit);
    document.getElementById('fullAccessInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') handleFullAccessSubmit();
    });
    document.getElementById('fullAccessInput').addEventListener('input', function() {
      document.getElementById('fullAccessError').style.display = 'none';
    });
  }

  // ---- Notes UI ----
  let sortType = localStorage.getItem("notesSortType") || "pinned";
  function sortNotes(a, b) {
    if (sortType === "pinned") {
      if ((a.pinned || false) !== (b.pinned || false)) return b.pinned - a.pinned;
      return b.created - a.created;
    }
    if (sortType === "title") {
      return (a.title || "").localeCompare(b.title || "");
    }
    // newest
    return b.created - a.created;
  }
  // Create note card now without inline editing
  function createNoteCard(note, readonly = false) {
    const card = document.createElement('article');
    card.className = 'note-card';
    if (note.pinned) card.classList.add('pinned');
    card.setAttribute('data-note-id', note.id);
    card.tabIndex = 0; // focusable for keyboard

    // Title preview
    const titleEl = document.createElement('h3');
    titleEl.className = 'note-title';
    titleEl.innerText = note.title || 'Untitled';

    // Content preview
    const contentEl = document.createElement('div');
    contentEl.className = 'note-content-preview';
    contentEl.innerText = note.content || '';

    // Header container for title and actions
    const header = document.createElement('div');
    header.className = 'note-header';
    header.appendChild(titleEl);

    if (!readonly) {
      const actions = document.createElement('div');
      actions.className = 'note-actions';

      // Pin button
      const pinBtn = document.createElement('button');
      pinBtn.setAttribute('aria-label', note.pinned ? "Unpin note" : "Pin note");
      pinBtn.className = 'pin-btn';
      pinBtn.innerHTML = note.pinned ? "üìå" : "üìç";
      pinBtn.title = note.pinned ? "Unpin note" : "Pin note";
      pinBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // prevent card click
        note.pinned = !note.pinned;
        saveNotes();
        renderNotes();
        updateCustomizePanel();
      });
      actions.appendChild(pinBtn);

      // Delete button
      const delBtn = document.createElement('button');
      delBtn.setAttribute('aria-label', 'Delete note');
      delBtn.innerHTML = '&times;';
      delBtn.title = "Delete note";
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // prevent card click
        if (confirm(`Delete note "${note.title}"?`)) {
          notes = notes.filter(n => n.id !== note.id);
          saveNotes();
          renderNotes();
          updateCustomizePanel();
          closeNoteModal(); // Close modal if open for this note
        }
      });
      actions.appendChild(delBtn);

      header.appendChild(actions);
    }

    card.appendChild(header);
    card.appendChild(contentEl);

    // Open note modal on card click
    card.addEventListener('click', () => {
      if (!readonly) {
        openNoteModal(note.id);
      }
    });
    card.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (!readonly) {
          openNoteModal(note.id);
        }
      }
    });

    return card;
  }

  function renderNotes() {
    const notesContainer = document.getElementById('notes');
    notesContainer.innerHTML = '';
    const readonly = !hasFullAccess();
    const searchTerm = (document.getElementById('searchNotes').value || '').toLowerCase();
    notes
      .filter(note => (note.visible !== false) && (note.title.toLowerCase().includes(searchTerm) || note.content.toLowerCase().includes(searchTerm)))
      .sort(sortNotes)
      .forEach(note => {
        notesContainer.appendChild(createNoteCard(note, readonly));
      });
    // Show/hide newNoteBtn depending on mode
    document.getElementById("newNoteBtn").style.display = hasFullAccess() ? "" : "none";
  }

  // ---- DRAGGABLE, EASY CUSTOMIZE PANEL ----
  function updateCustomizePanel() {
    const customizePanel = document.getElementById('customizePanel');
    const container = document.getElementById('customizeCheckboxes');
    container.innerHTML = '';
    if (!hasFullAccess()) {
      customizePanel.style.display = 'none';
      return;
    }
    customizePanel.style.display = '';
    notes.forEach((note, idx) => {
      const label = document.createElement('label');
      label.htmlFor = `toggle-${note.id}`;
      label.className = 'customize-row';
      label.draggable = true;
      label.dataset.idx = idx;
      // Drag handlers
      label.addEventListener('dragstart', (e) => {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData('text/plain', idx);
        label.classList.add('dragging');
      });
      label.addEventListener('dragend', () => { label.classList.remove('dragging'); });
      label.addEventListener('dragover', (e) => {
        e.preventDefault();
        label.classList.add('dragover');
      });
      label.addEventListener('dragleave', () => { label.classList.remove('dragover'); });
      label.addEventListener('drop', (e) => {
        e.preventDefault();
        const fromIdx = +e.dataTransfer.getData('text/plain');
        const toIdx = idx;
        if (fromIdx !== toIdx) {
          // Move note in array
          const moved = notes.splice(fromIdx, 1)[0];
          notes.splice(toIdx, 0, moved);
          saveNotes();
          updateCustomizePanel();
          renderNotes();
        }
      });
      // Drag handle icon
      const dragIcon = document.createElement('span');
      dragIcon.className = 'drag-icon';
      dragIcon.innerHTML = "‚ò∞";
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `toggle-${note.id}`;
      checkbox.checked = note.visible !== false;
      checkbox.setAttribute('aria-checked', checkbox.checked);
      checkbox.addEventListener('change', () => {
        note.visible = checkbox.checked;
        saveNotes();
        renderNotes();
      });
      label.appendChild(dragIcon);
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(note.title));
      container.appendChild(label);
    });
  }

  function resetNotes() {
    if (confirm('Reset all notes to default? This cannot be undone.')) {
      notes = defaultNotes.map(n => ({ ...n, visible: true }));
      saveNotes();
      renderNotes();
      updateCustomizePanel();
    }
  }

  // ---- New Note ----
  function addNewNote() {
    const id = "note" + Math.random().toString(36).slice(2, 10);
    const note = {
      id,
      title: "Untitled",
      content: "",
      visible: true,
      pinned: false,
      created: Date.now()
    };
    notes.unshift(note);
    saveNotes();
    selectedNoteId = id;
    renderNotes();
    updateCustomizePanel();
    openNoteModal(id);
  }

  // ---- Sorting Menu ----
  function setupSortMenu() {
    const sortBtn = document.getElementById("sortNotesBtn");
    const sortMenu = document.getElementById("sortMenu");
    sortBtn.addEventListener("click", function(e) {
      sortMenu.style.display = sortMenu.style.display === "block" ? "none" : "block";
      sortMenu.focus();
    });
    sortMenu.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", function() {
        sortType = btn.dataset.sort;
        localStorage.setItem("notesSortType", sortType);
        sortMenu.style.display = "none";
        renderNotes();
      });
    });
    // Close menu when clicking outside
    document.addEventListener("mousedown", function(e){
      if (!sortMenu.contains(e.target) && e.target !== sortBtn) {
        sortMenu.style.display = "none";
      }
    });
  }

  // ---- Keyboard Shortcuts ----
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      if (!hasFullAccess()) return;
      if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA" || document.activeElement.isContentEditable) return;
      // n: new note
      if (e.key === "n" && !e.ctrlKey && !e.altKey) {
        addNewNote();
        e.preventDefault();
      }
      // /: focus search
      if (e.key === "/" && !e.ctrlKey && !e.altKey) {
        document.getElementById("searchNotes").focus();
        e.preventDefault();
      }
      // p: pin/unpin selected note
      if (e.key === "p" && selectedNoteId) {
        const note = notes.find(n => n.id === selectedNoteId);
        if (note) {
          note.pinned = !note.pinned;
          saveNotes();
          renderNotes();
          updateCustomizePanel();
        }
        e.preventDefault();
      }
      // Arrow up/down to move selection
      if (["ArrowUp", "ArrowDown"].includes(e.key)) {
        const visibleNotes = notes.filter(n => n.visible !== false).sort(sortNotes);
        let idx = visibleNotes.findIndex(n => n.id === selectedNoteId);
        if (idx >= 0) {
          if (e.key === "ArrowUp") idx = Math.max(0, idx-1);
          else idx = Math.min(visibleNotes.length-1, idx+1);
        } else {
          idx = 0;
        }
        selectedNoteId = visibleNotes[idx]?.id;
        renderNotes();
        setTimeout(() => {
          const card = document.querySelector(`.note-card[data-note-id="${selectedNoteId}"]`);
          if (card) card.focus();
        }, 50);
        e.preventDefault();
      }
      // Escape closes modal if open
      if (e.key === "Escape") {
        if (isNoteModalOpen()) {
          closeNoteModal();
          e.preventDefault();
        }
      }
    });
  }

  // ---- Note Modal Logic ----
  const modalOverlay = document.getElementById('noteModalOverlay');
  const modal = document.getElementById('noteModal');
  const modalTitleInput = document.getElementById('modalNoteTitle');
  const modalContentTextarea = document.getElementById('modalNoteContent');
  const modalPinToggle = document.getElementById('modalPinToggle');
  const modalDeleteBtn = document.getElementById('modalDeleteBtn');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const modalCloseIconBtn = modal.querySelector('header button.close-btn');

  let modalNoteId = null;

  function isNoteModalOpen() {
    return modalOverlay.classList.contains('active');
  }
  function openNoteModal(id) {
    modalNoteId = id;
    const note = notes.find(n => n.id === id);
    if (!note) return;
    modalTitleInput.value = note.title || 'Untitled';
    modalContentTextarea.value = note.content || '';
    updatePinToggle(note.pinned);
    modalPinToggle.setAttribute('aria-pressed', note.pinned ? 'true' : 'false');
    modalOverlay.classList.add('active');
    modalTitleInput.focus();
    disablePageScroll(true);
    trapFocus(modal);
  }
  function closeNoteModal() {
    modalOverlay.classList.remove('active');
    modalNoteId = null;
    disablePageScroll(false);
    document.activeElement.blur();
  }
  function updatePinToggle(pinned) {
    if(pinned) {
      modalPinToggle.classList.add('pinned');
      modalPinToggle.innerText = 'üìå Unpin';
      modalPinToggle.setAttribute('aria-pressed', 'true');
      modalPinToggle.title = 'Unpin note';
    } else {
      modalPinToggle.classList.remove('pinned');
      modalPinToggle.innerText = 'üìç Pin';
      modalPinToggle.setAttribute('aria-pressed', 'false');
      modalPinToggle.title = 'Pin note';
    }
  }

  modalTitleInput.addEventListener('input', () => {
    if (!modalNoteId) return;
    const note = notes.find(n => n.id === modalNoteId);
    if (!note) return;
    note.title = modalTitleInput.value.trim() || 'Untitled';
    saveNotes();
    renderNotes();
    updateCustomizePanel();
  });
  modalContentTextarea.addEventListener('input', () => {
    if (!modalNoteId) return;
    const note = notes.find(n => n.id === modalNoteId);
    if (!note) return;
    note.content = modalContentTextarea.value;
    saveNotes();
    renderNotes();
    updateCustomizePanel();
  });
  modalPinToggle.addEventListener('click', () => {
    if (!modalNoteId) return;
    const note = notes.find(n => n.id === modalNoteId);
    if (!note) return;
    note.pinned = !note.pinned;
    updatePinToggle(note.pinned);
    saveNotes();
    renderNotes();
    updateCustomizePanel();
  });
  modalDeleteBtn.addEventListener('click', () => {
    if (!modalNoteId) return;
    const note = notes.find(n => n.id === modalNoteId);
    if (!note) return;
    if (confirm(`Delete note "${note.title}"?`)) {
      notes = notes.filter(n => n.id !== modalNoteId);
      saveNotes();
      renderNotes();
      updateCustomizePanel();
      closeNoteModal();
    }
  });
  modalCloseBtn.addEventListener('click', closeNoteModal);
  modalCloseIconBtn.addEventListener('click', closeNoteModal);

  // Close modal on overlay click (but not when clicking modal content)
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) {
      closeNoteModal();
    }
  });

  // Trap focus inside modal
  function trapFocus(element) {
    const focusableSelectors = [
      'a[href]:not([tabindex="-1"])',
      'button:not([disabled]):not([tabindex="-1"])',
      'textarea:not([disabled]):not([tabindex="-1"])',
      'input[type="text"]:not([disabled]):not([tabindex="-1"])',
      'input[type="password"]:not([disabled]):not([tabindex="-1"])',
      '[tabindex]:not([tabindex="-1"])'
    ];
    const focusable = element.querySelectorAll(focusableSelectors.join(','));
    if(focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    element.addEventListener('keydown', function handler(e) {
      if(e.key === 'Tab') {
        if(e.shiftKey) {
          if(document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if(document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    });
  }

  // Disable scroll of page behind modal
  function disablePageScroll(disable) {
    if(disable) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
  }

  // ---- Drawing Canvas Logic ----
  (function(){
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');

    let drawing = false;
    let lastX = 0;
    let lastY = 0;
    let startX = 0;
    let startY = 0;
    let currentTool = 'pencil'; // pencil, rectangle, circle, eraser
    let actions = [];
    let redoStack = [];
    let previewingShape = null;

    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#facc15';
    ctx.lineWidth = 4;

    // Resize canvas and preserve drawing content
    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();

      // Save current canvas content
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(canvas, 0, 0);

      // Resize canvas to new size
      canvas.width = rect.width;
      canvas.height = rect.height;

      // Redraw saved content
      ctx.drawImage(tempCanvas, 0, 0);

      // Redraw vector actions to keep state consistent
      redrawCanvas();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function getXY(e) {
      if (e.touches && e.touches.length > 0) {
        const touch = e.touches[0];
        return [touch.clientX - canvas.getBoundingClientRect().left, touch.clientY - canvas.getBoundingClientRect().top];
      } else {
        return [e.clientX - canvas.getBoundingClientRect().left, e.clientY - canvas.getBoundingClientRect().top];
      }
    }

    function saveAction(action) {
      actions.push(action);
      redoStack = [];
    }
    function redrawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      actions.forEach(act => drawAction(ctx, act));
    }
    function drawAction(ctx, action) {
      ctx.save();
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = action.color || '#facc15';
      ctx.lineWidth = action.lineWidth || 4;

      if(action.type === 'line'){
        ctx.beginPath();
        ctx.moveTo(action.startX, action.startY);
        ctx.lineTo(action.endX, action.endY);
        ctx.stroke();
      } else if(action.type === 'rectangle'){
        ctx.strokeRect(action.x, action.y, action.width, action.height);
      } else if(action.type === 'circle'){
        ctx.beginPath();
        ctx.arc(action.x, action.y, action.radius, 0, Math.PI * 2);
        ctx.stroke();
      } else if(action.type === 'eraser'){
        // For eraser, clear the rectangle area on redraw
        ctx.clearRect(action.x, action.y, action.width, action.height);
      }
      ctx.restore();
    }

    function startDrawing(e) {
      drawing = true;
      [lastX, lastY] = getXY(e);
      [startX, startY] = [lastX, lastY];
      if(currentTool === 'pencil' || currentTool === 'eraser'){
        if(currentTool === 'eraser'){
          eraseAt(lastX, lastY);
        } else {
          saveAction({
            type: 'line',
            startX: lastX,
            startY: lastY,
            endX: lastX,
            endY: lastY,
            color: ctx.strokeStyle,
            lineWidth: ctx.lineWidth,
          });
        }
      }
      e.preventDefault();
    }
    function stopDrawing(e) {
      if(!drawing) return;
      drawing = false;
      if(currentTool === 'rectangle'){
        const [x, y] = getXY(e);
        const rect = createRect(startX, startY, x, y);
        saveAction({
          type: 'rectangle',
          x: rect.x,
          y: rect.y,
          width: rect.width,
          height: rect.height,
          color: ctx.strokeStyle,
          lineWidth: ctx.lineWidth,
        });
        previewingShape = null;
        redrawCanvas();
      } else if(currentTool === 'circle'){
        const [x, y] = getXY(e);
        const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
        saveAction({
          type: 'circle',
          x: startX,
          y: startY,
          radius,
          color: ctx.strokeStyle,
          lineWidth: ctx.lineWidth,
        });
        previewingShape = null;
        redrawCanvas();
      }
      e.preventDefault();
    }
    function draw(e) {
      if (!drawing) return;
      const [x, y] = getXY(e);
      if (currentTool === 'pencil') {
        const lastAction = actions[actions.length - 1];
        if(lastAction && lastAction.type === 'line' && lastAction.endX === lastX && lastAction.endY === lastY){
          lastAction.endX = x;
          lastAction.endY = y;
        } else {
          saveAction({
            type: 'line',
            startX: lastX,
            startY: lastY,
            endX: x,
            endY: y,
            color: ctx.strokeStyle,
            lineWidth: ctx.lineWidth,
          });
        }
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        [lastX, lastY] = [x, y];
      } else if (currentTool === 'eraser') {
        eraseAt(x, y);
        [lastX, lastY] = [x, y];
      } else if(currentTool === 'rectangle'){
        previewingShape = {
          type: 'rectangle',
          x1: startX,
          y1: startY,
          x2: x,
          y2: y,
        };
        redrawCanvas();
        drawPreviewRect(previewingShape);
      } else if(currentTool === 'circle'){
        previewingShape = {
          type: 'circle',
          x: startX,
          y: startY,
          radius: Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2)),
        };
        redrawCanvas();
        drawPreviewCircle(previewingShape);
      }
      e.preventDefault();
    }
    function eraseAt(x, y){
      const size = ctx.lineWidth * 2;
      ctx.clearRect(x - size/2, y - size/2, size, size);
      saveAction({
        type: 'eraser',
        x: x - size/2,
        y: y - size/2,
        width: size,
        height: size,
      });
    }
    function createRect(x1, y1, x2, y2){
      const x = Math.min(x1,x2);
      const y = Math.min(y1,y2);
      const width = Math.abs(x1-x2);
      const height = Math.abs(y1-y2);
      return {x,y,width,height};
    }
    function drawPreviewRect(rect) {
      if(!rect) return;
      ctx.save();
      ctx.strokeStyle = ctx.strokeStyle || '#facc15';
      ctx.lineWidth = ctx.lineWidth || 4;
      ctx.setLineDash([6]);
      const r = createRect(rect.x1, rect.y1, rect.x2, rect.y2);
      ctx.strokeRect(r.x, r.y, r.width, r.height);
      ctx.restore();
    }
    function drawPreviewCircle(circ){
      if(!circ) return;
      ctx.save();
      ctx.strokeStyle = ctx.strokeStyle || '#facc15';
      ctx.lineWidth = ctx.lineWidth || 4;
      ctx.setLineDash([6]);
      ctx.beginPath();
      ctx.arc(circ.x, circ.y, circ.radius, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();
    }

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);

    // Control elements
    const colorPicker = document.getElementById('colorPicker');
    const lineWidthRange = document.getElementById('lineWidthRange');
    const clearCanvasBtn = document.getElementById('clearCanvasBtn');
    const saveCanvasBtn = document.getElementById('saveCanvasBtn');

    colorPicker.addEventListener('input', function() {
      ctx.strokeStyle = this.value;
    });

    lineWidthRange.addEventListener('change', function() {
      ctx.lineWidth = parseInt(this.value, 10) || 4;
    });

    clearCanvasBtn.addEventListener('click', () => {
      if(confirm('Clear the entire drawing?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        actions = [];
        redoStack = [];
      }
    });

    saveCanvasBtn.addEventListener('click', () => {
      try {
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = 'drawing.png';
        link.href = dataUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        alert('Sorry, this browser does not support saving images.');
      }
    });

    // Tool buttons
    const toolButtons = {
      pencil: document.getElementById('pencilBtn'),
      rectangle: document.getElementById('rectangleBtn'),
      circle: document.getElementById('circleBtn'),
      eraser: document.getElementById('eraserBtn'),
      undo: document.getElementById('undoBtn'),
      redo: document.getElementById('redoBtn'),
    };

    function setActiveTool(tool) {
      currentTool = tool;
      canvas.style.cursor = 'crosshair';
      for(const key in toolButtons){
        if(toolButtons[key]){
          if(key === tool){
            toolButtons[key].classList.add('active');
          } else {
            toolButtons[key].classList.remove('active');
          }
        }
      }
    }
    toolButtons.pencil.addEventListener('click', () => setActiveTool('pencil'));
    toolButtons.rectangle.addEventListener('click', () => setActiveTool('rectangle'));
    toolButtons.circle.addEventListener('click', () => setActiveTool('circle'));
    toolButtons.eraser.addEventListener('click', () => setActiveTool('eraser'));

    // Undo functionality
    function undo() {
      if(actions.length === 0) return;
      const last = actions.pop();
      redoStack.push(last);
      redrawCanvas();
    }
    function redo() {
      if(redoStack.length === 0) return;
      const action = redoStack.pop();
      actions.push(action);
      redrawCanvas();
    }
    toolButtons.undo.addEventListener('click', undo);
    toolButtons.redo.addEventListener('click', redo);

    // Back button to notes view
    document.getElementById('closeVideoDrawingBtn').addEventListener('click', () => {
      toggleViews(false);
    });

    // Move button to show drawing view
    document.getElementById('moveBtn').addEventListener('click', () => {
      toggleViews(true);
    });

    function toggleViews(showDrawing) {
      const notesView = document.getElementById('notesView');
      const drawingView = document.getElementById('videoDrawingView');
      if (showDrawing) {
        notesView.style.display = 'none';
        drawingView.classList.add('active');
      } else {
        notesView.style.display = 'block';
        drawingView.classList.remove('active');
      }
    }
  })();

  // ---- Render App (main controls) ----
  function renderApp() {
    document.getElementById('passwordOverlay').style.display = 'none';
    document.getElementById('fullAccessOverlay').style.display = 'none';
    document.getElementById('mainContent').style.display = 'flex';
    const resetBtn = document.getElementById('resetNotesBtn');
    const viewOnlyLoginBtn = document.getElementById('viewOnlyLoginBtn');
    const viewOnlyInfo = document.getElementById('viewOnlyInfo');
    if (hasFullAccess()) {
      resetBtn.style.display = '';
      document.getElementById('customizePanel').style.display = '';
      viewOnlyLoginBtn.style.display = 'none';
      viewOnlyInfo.style.display = 'none';
      resetBtn.onclick = resetNotes;
      document.getElementById("newNoteBtn").style.display = "";
      document.getElementById("newNoteBtn").onclick = addNewNote;
    } else {
      resetBtn.style.display = 'none';
      document.getElementById('customizePanel').style.display = 'none';
      viewOnlyLoginBtn.style.display = '';
      viewOnlyInfo.style.display = '';
      document.getElementById("newNoteBtn").style.display = "none";
      viewOnlyLoginBtn.onclick = () => {
        document.getElementById('fullAccessOverlay').style.display = 'flex';
        document.getElementById('fullAccessInput').focus();
      };
    }
    renderNotes();
    updateCustomizePanel();
  }

  // ---- Accessibility: focus trap for overlays ----
  function trapFocus(element) {
    const focusable = element.querySelectorAll("input,button,textarea");
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    element.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    });
  }

  // DOMContentLoaded initial setup
  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    trapFocus(document.getElementById('passwordOverlay'));
    trapFocus(document.getElementById('fullAccessOverlay'));
    document.getElementById('searchNotes').addEventListener('input', renderNotes);
    setupSortMenu();
    setupKeyboardShortcuts();
    if (isAuthenticated()) {
      document.getElementById('passwordOverlay').style.display = 'none';
      document.getElementById('mainContent').style.display = 'flex';
      renderApp();
    } else {
      setupPasswordForm();
      document.getElementById('passwordInput').focus();
    }
    setupFullAccessForm();
  });
</script>
</body>
</html>

